<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Days Since Last Happened</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
    }
    #controls {
      text-align: center;
      margin-bottom: 20px;
    }
    #eventGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .event-box {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 15px;
      text-align: center;
      background-color: #f9f9f9;
      position: relative;
    }
    .event-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .event-days {
      font-size: 1.2em;
      margin-bottom: 10px;
    }
    .btn {
      cursor: pointer;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      margin: 0 5px;
    }
    .btn-refresh {
      background-color: #28a745;
      color: #fff;
    }
    .btn-delete {
      background-color: #dc3545;
      color: #fff;
    }
    .add-form {
      display: inline-block;
    }
    .add-form input[type="text"] {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .add-form button {
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      margin-left: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Days Since These Events Last Happened</h1>

  <!-- Controls for adding a new event -->
  <div id="controls">
    <form class="add-form" onsubmit="addEvent(event)">
      <input type="text" id="newEventName" placeholder="Event name" required />
      <button type="submit">Add Event</button>
    </form>
  </div>

  <!-- Grid container for events -->
  <div id="eventGrid"></div>

  <script>
    // Local Storage Key
    const STORAGE_KEY = 'daysSinceEvents';

    // Load events from localStorage or create an empty array if none exist
    let events = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    // Helper function: Calculate difference in days between now and a given date
    function daysSince(dateString) {
      const now = new Date();
      const past = new Date(dateString);
      const diffInMs = now - past;
      // Convert milliseconds to days (rounded down)
      return Math.floor(diffInMs / (1000 * 60 * 60 * 24));
    }

    // Render all events in the grid
    function renderEvents() {
      const eventGrid = document.getElementById('eventGrid');
      eventGrid.innerHTML = ''; // Clear existing items

      events.forEach((ev, index) => {
        const dayCount = daysSince(ev.lastUpdated);

        const box = document.createElement('div');
        box.className = 'event-box';

        const title = document.createElement('div');
        title.className = 'event-title';
        title.textContent = ev.name;

        const dayDisplay = document.createElement('div');
        dayDisplay.className = 'event-days';
        dayDisplay.textContent = `${dayCount} day${dayCount !== 1 ? 's' : ''} since last happened`;

        // Refresh button
        const refreshBtn = document.createElement('button');
        refreshBtn.className = 'btn btn-refresh';
        refreshBtn.textContent = 'Refresh';
        refreshBtn.addEventListener('click', () => refreshEvent(index));

        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-delete';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', () => deleteEvent(index));

        // Edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-edit';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', () => editEvent(index));

        box.appendChild(title);
        box.appendChild(dayDisplay);
        box.appendChild(refreshBtn);
        box.appendChild(deleteBtn);
        box.appendChild(editBtn);

        eventGrid.appendChild(box);
      });
    }

    // Save events array to localStorage
    function saveEvents() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
    }

    // Add a new event (sets its 'lastUpdated' to now)
    function addEvent(e) {
      e.preventDefault(); // Prevent page refresh
      const input = document.getElementById('newEventName');
      const eventName = input.value.trim();
      if (!eventName) return;

      events.push({
        name: eventName,
        lastUpdated: new Date().toISOString()
      });
      saveEvents();
      renderEvents();
      input.value = ''; // Clear the input
    }

    // Refresh an event (set 'lastUpdated' to now)
    function refreshEvent(index) {
      events[index].lastUpdated = new Date().toISOString();
      saveEvents();
      renderEvents();
    }

    // Delete an event
    function deleteEvent(index) {
      events.splice(index, 1);
      saveEvents();
      renderEvents();
    }

    // Edit an event: replaces the box with inline inputs to edit the name and time
    function editEvent(index) {
      const ev = events[index];
      const eventGrid = document.getElementById('eventGrid');
      // Assumes the order of boxes corresponds to events order
      const box = eventGrid.children[index];
      box.innerHTML = '';

      const form = document.createElement('form');
      form.onsubmit = function(e) {
        e.preventDefault();
        const newName = nameInput.value.trim();
        const newDatetime = dateInput.value;
        if(newName && newDatetime) {
          events[index].name = newName;
          // Convert the datetime-local value back to an ISO string
          events[index].lastUpdated = new Date(newDatetime).toISOString();
          saveEvents();
          renderEvents();
        }
      };

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = ev.name;
      nameInput.required = true;
      nameInput.style.marginRight = '5px';

      const dateInput = document.createElement('input');
      dateInput.type = 'datetime-local';
      // Convert stored ISO date to a format suitable for datetime-local input (in local time)
      let localDate = new Date(ev.lastUpdated);
      let tzOffset = localDate.getTimezoneOffset() * 60000;
      let localISO = new Date(localDate - tzOffset).toISOString().slice(0,16);
      dateInput.value = localISO;
      dateInput.required = true;
      dateInput.style.marginRight = '5px';

      const updateBtn = document.createElement('button');
      updateBtn.type = 'submit';
      updateBtn.textContent = 'Update';
      updateBtn.className = 'btn';

      const cancelBtn = document.createElement('button');
      cancelBtn.type = 'button';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'btn';
      cancelBtn.style.marginLeft = '5px';
      cancelBtn.addEventListener('click', () => renderEvents());

      form.appendChild(nameInput);
      form.appendChild(dateInput);
      form.appendChild(updateBtn);
      form.appendChild(cancelBtn);

      box.appendChild(form);
    }

    // Initial render on page load
    renderEvents();
  </script>
</body>
</html>
